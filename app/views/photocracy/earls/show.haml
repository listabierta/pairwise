#primary_content
  %h1
    =t ('common.title')
  %p
    =t('common.instructions')
  #prompt
    =render(:partial => 'questions/prompt')
  .form_actions
    =link_to_function t('vote.cant_decide'), "submitCantDecide(this);", :id => "cant_decide_btn", :class => 'btn btn-warning', 'data-action' => "#{skip_question_prompt_url(@question.id, @prompt.id, :format => :js)}"
    =link_to t('nav.view_results'), url_for(:action => :results, :controller => :questions, :id => params[:id]), :class => 'btn btn-primary'
    -if !current_user.nil? && (current_user.owns?(@earl) || current_user.admin?)
      =link_to t('nav.manage_question'), url_for(:controller => :questions, :action => :admin, :id => @earl.name)
.container
  #secondary_content
    .col-md-6
      Llevas <span id="visitor_votes"></span> voto<span id="s">s</span> hasta el momento
      -if @show_average_votes
        %span.normal= "(el promedio es <span id='average_votes'>#{@question.attributes['average_votes']}</span>)"
    .col-md-6.align-right
      = t('common.X_votes_on_Y_ideas',
          :votes_count => @question.attributes['votes_count'].to_i,
          :ideas_count => @question.attributes['item_count'] - @question.attributes["inactive_choices_count"],
          :"1" => '<span id="votes_count">',
          :"_1" => "</span>",
          :"2" => '<span id="item_count">',
          :"_2" => '</span>')

      .padding
        
        .admin-link.small_margin_top
          

  .clear

  -if @earl.flag_enabled?
    #flag_as_inappropriate{:style => 'display:none', :title => t('vote.flag_as_inappropriate')}
      %form{:action => "#{flag_question_prompt_url(@question.id, @prompt.id, :format => :js)}", :id => 'flag_as_inappropriate_form'}
        = t('vote.please_explain_flag')
        %p
          = text_area_tag 'inappropriate_reason', "", :style => 'width:100%'
          = hidden_field_tag 'inappropriate_side'
        %p
          %input.flag_submit_button.button{:type => 'submit', :value => "#{t('vote.submit')}"}

  #add_photo{:style => 'display:none;', :title => t('vote.add_your_idea_button')}
    #photo_step_1
      %p
        By uploading an image, I agree to place my image in the public domain under a
        =link_to 'Creative Commons CC0 waiver', "http://creativecommons.org/publicdomain/zero/1.0/", :target => '_blank'
      %p#file_error{:style => 'display:none;color:red;'}
        =t('vote.photo_format_error')
      %p
        %input{:type => 'submit', :value => t('vote.choose_file'), :href => add_idea_question_url(@question, :format => :js), :id => 'choose_file', :question_id => @question.id}

    #photo_step_2{:style => 'display:none'}
      %p
        =t('vote.uploading_photo')
      =image_tag('/images/photocracy/indicator.gif')

    #photo_step_3{:style => 'display:none'}
      .photo_container
        .float_left{:style => 'width:40%;'}
          .photo_success_message
            %p
              %strong
                =t('vote.thanks')
              %br
              -if @question.attributes['it_should_autoactivate_ideas']
                =t('vote.photo_accepted')
              -else
                =t('vote.photo_submitted')
          .photo_error_message
            Whoops! There was a problem uploading this image.
            #photo_details_message
              Please try again


        .float_right{:style => 'width:40%;'}
          %img{:id => 'uploaded_thumbnail', :style => 'display:none'}
      %br
      %br
      %br
      =link_to_function t('vote.add_another_idea_button'), "$('#add_photo').dialog('close'); $('#add_photo').dialog('open');", :class => 'blue button float_right', :id => 'add_photo_button_for_dialog', :style => 'font-size:0.8em;'
  

  :javascript
    $(document).ready(function(){
      $('#cant_decide_options').dialog({autoOpen:false, modal:true, width:330});

      $('#flag_as_inappropriate').dialog({autoOpen:false, modal:true, width:450});

      $('#add_photo').dialog({
        autoOpen:false,
        width:400,
        beforeclose: function(event, ui) {
          $('#photo_step_1').show();
          $('#file_error').hide();
          $('#photo_step_2').hide();
          $('#photo_step_3').hide();
        }
      });
      

      // load the visitor's voting history
      jQuery.get('/questions/#{@question.id}/visitor_voting_history.json', function(data){

        updateVisitorVotes(data['votes'].length);

        jQuery.each(data['votes'], function() {
          var left_url = "/#{@earl.name}/choices/" + this['left_choice_id'] + "?locale=" + RAILS_LOCALE;
          var right_url = "/#{@earl.name}/choices/" + this['right_choice_id'] + "?locale=" + RAILS_LOCALE;

          addThumbnailsToHistory(this['left_choice_thumb'], left_url, this['right_choice_thumb'], right_url, data['voted_at'], this['winner']);
        });
    	});
      jQuery.preLoadImages('#{@future_left_choice_photo.image.url(:medium)}','#{@future_right_choice_photo.image.url(:medium)}');
    });
